{% extends 'moviepact/base.html' %}

{% block content %}


<style>
    .movie-container {
        padding-top: 100px;
        margin: 20px 0px;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        width: 1000px;
    }

    .movie-container select {
        appearance: none;
        -moz-appearance: none;
        -webkit-appearance: none;
        border: 0;
        padding: 5px 15px;
        margin-bottom: 40px;
        font-size: 14px;
        border-radius: 5px;
    }

    .container {
        perspective: 1000px;
        margin: 40px 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .seat {
        background-color: #444451;
        height: 12px;
        width: 15px;
        margin: 3px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

    .selected {
        background-color: #0081cb;
    }

    .occupied {
        background-color: #fff;
    }
    .reserved {
        background-color: green;
    }

    .seat:nth-of-type(2) {
        margin-right: 18px;
    }

    .seat:nth-last-of-type(2) {
        margin-left: 18px;
    }

    .seat:not(.occupied, .reserved):hover {
        cursor: pointer;
        transform: scale(1.2);
    }
    
    .showcase .seat:not(.occupied, .reserved):hover {
        cursor: default;
        transform: scale(1);
    }
    

    .showcase {
        display: flex;
        justify-content: space-between;
        list-style-type: none;
        background: rgba(0, 0, 0, 0.1);
        padding: 5px 10px;
        border-radius: 5px;
        color: #777;
    }

    .showcase li {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
    }

    .showcase li small {
        margin-left: 2px;
    }

    .row {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .screen {
        background: #fff;
        height: 70px;
        width: 70%;
        margin: 15px 0;
        transform: rotateX(-45deg);
        box-shadow: 0 3px 10px rgba(255, 255, 255, 0.7);
    }

    p.text {
        margin: 40px 0;
    }

    p.text span {
        color: #0081cb;
        font-weight: 600;
        box-sizing: content-box;
    }

    body {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background-color: #A9A9A9;
        color: #fff;
        margin: 0;
    }


    * {

        box-sizing: border-box;
    }

    #my-footer{
        display: none;
    }
</style>



<div class="movie-container">
    <h2>{{seance.movie.title}} {{seance.date}}</h2>
    <p id="movie" style="display: none;">{{seance.price}}</p>
    <ul class="showcase">
        <li>
            <div class="seat"></div>
            <small>Available</small>
        </li>
        <li>
            <div class="seat selected"></div>
            <small>Selected</small>
        </li>
        <li>
            <div class="seat occupied"></div>
            <small>Occupied</small>
        </li>
        <li>
            <div class="seat reserved"></div>
            <small>Your seats</small>
        </li>
    </ul>

    <div class="container">
        <div class="screen"></div>

        <div class="row">
            <div class="seat" id="1-1"><p style="display: none;">1-1</p></div>
            <div class="seat" id="1-2"><p style="display: none;">1-2</p></div>
            <div class="seat" id="1-3"><p style="display: none;">1-3</p></div>
            <div class="seat" id="1-4"><p style="display: none;">1-4</p></div>
            <div class="seat" id="1-5"><p style="display: none;">1-5</p></div>
            <div class="seat" id="1-6"><p style="display: none;">1-6</p></div>
            <div class="seat" id="1-7"><p style="display: none;">1-7</p></div>
            <div class="seat" id="1-8"><p style="display: none;">1-8</p></div>
        </div>
        <div class="row">
            <div class="seat" id="2-1"><p style="display: none;">2-1</p></div>
            <div class="seat" id="2-2"><p style="display: none;">2-2</p></div>
            <div class="seat" id="2-3"><p style="display: none;">2-3</p></div>
            <div class="seat" id="2-4"><p style="display: none;">2-4</p></div>
            <div class="seat" id="2-5"><p style="display: none;">2-5</p></div>
            <div class="seat" id="2-6"><p style="display: none;">2-6</p></div>
            <div class="seat" id="2-7"><p style="display: none;">2-7</p></div>
            <div class="seat" id="2-8"><p style="display: none;">2-8</p></div>
        </div>
        <div class="row">
            <div class="seat" id="3-1"><p style="display: none;">3-1</p></div>
            <div class="seat" id="3-2"><p style="display: none;">3-2</p></div>
            <div class="seat" id="3-3"><p style="display: none;">3-3</p></div>
            <div class="seat" id="3-4"><p style="display: none;">3-4</p></div>
            <div class="seat" id="3-5"><p style="display: none;">3-5</p></div>
            <div class="seat" id="3-6"><p style="display: none;">3-6</p></div>
            <div class="seat" id="3-7"><p style="display: none;">3-7</p></div>
            <div class="seat" id="3-8"><p style="display: none;">3-8</p></div>
        </div>
        <div class="row">
            <div class="seat" id="4-1"><p style="display: none;">4-1</p></div>
            <div class="seat" id="4-2"><p style="display: none;">4-2</p></div>
            <div class="seat" id="4-3"><p style="display: none;">4-3</p></div>
            <div class="seat" id="4-4"><p style="display: none;">4-4</p></div>
            <div class="seat" id="4-5"><p style="display: none;">4-5</p></div>
            <div class="seat" id="4-6"><p style="display: none;">4-6</p></div>
            <div class="seat" id="4-7"><p style="display: none;">4-7</p></div>
            <div class="seat" id="4-8"><p style="display: none;">4-8</p></div>
        </div>
        <div class="row">
            <div class="seat" id="5-1"><p style="display: none;">5-1</p></div>
            <div class="seat" id="5-2"><p style="display: none;">5-2</p></div>
            <div class="seat" id="5-3"><p style="display: none;">5-3</p></div>
            <div class="seat" id="5-4"><p style="display: none;">5-4</p></div>
            <div class="seat" id="5-5"><p style="display: none;">5-5</p></div>
            <div class="seat" id="5-6"><p style="display: none;">5-6</p></div>
            <div class="seat" id="5-7"><p style="display: none;">5-7</p></div>
            <div class="seat" id="5-8"><p style="display: none;">5-8</p></div>
        </div>
        <div class="row">
            <div class="seat" id="6-1"><p style="display: none;">6-1</p></div>
            <div class="seat" id="6-2"><p style="display: none;">6-2</p></div>
            <div class="seat" id="6-3"><p style="display: none;">6-3</p></div>
            <div class="seat" id="6-4"><p style="display: none;">6-4</p></div>
            <div class="seat" id="6-5"><p style="display: none;">6-5</p></div>
            <div class="seat" id="6-6"><p style="display: none;">6-6</p></div>
            <div class="seat" id="6-7"><p style="display: none;">6-7</p></div>
            <div class="seat" id="6-8"><p style="display: none;">6-8</p></div>
        </div>

        <p class="text">
            You have selected <span id="count">0</span> seats for the total price of <span id="total">0</span>$
        </p>
    </div>
    <button type="button" class="btn btn-warning" id="buy-button">
        Buy
    </button>
    <p id="taken-seats" style="display: none;">{{taken_seats}}</p>
    <p id="reserved-seats" style="display: none;">{{reserved_seats}}</p>
</div>


<script>
    const container = document.querySelector('.container');
    const seats = document.querySelectorAll('.row .seat:not(.occupied)');
    const count = document.getElementById('count');
    const total = document.getElementById('total');
    const movieSelect = document.getElementById('movie');
    const taken_seats = document.getElementById('taken-seats').innerHTML.split(',')
    const reservedSeats = document.getElementById('reserved-seats').innerHTML.split(',')


    let ticketPrice = +movieSelect.innerHTML;
    // Selected seats
    let seatsNumbers = []

    //Update total and count
    function updateSelectedCount() {
        const selectedSeats = document.querySelectorAll('.row .seat.selected');
        const selectedSeatsCount = selectedSeats.length;
        count.innerText = selectedSeatsCount;
        total.innerText = selectedSeatsCount * ticketPrice;
    }


    //Seat click event
    container.addEventListener('click', e => {
        if (e.target.classList.contains('seat') &&
            !e.target.classList.contains('occupied') &&
            !e.target.classList.contains('reserved')) {
            e.target.classList.toggle('selected');

            //Append selected seats to the list
            let number = e.target.innerHTML.slice(26, 29)
            
            if(seatsNumbers.includes(number)){
                //If selected seat is already in array, delete it
                const index = seatsNumbers.indexOf(number)
                seatsNumbers.splice(index, 1)
                
            }else{
                //If selected seat is not in array, append it
                seatsNumbers.push(number)
            }
            
            console.log(seatsNumbers)
            console.log(seatsNumbers.length)
        }
        updateSelectedCount();
    });

    //Mark occupied seats
    console.log(taken_seats)
    if(taken_seats != ''){
    for (const element of taken_seats){
        let seat = document.getElementById(element.trim())
        seat.classList.add('occupied')
    }
    }

    //Mark seats reserved by authenticated user
    console.log(reservedSeats)
    if(reservedSeats!= ''){
    for (let x of reservedSeats){
        let  reservedSeat = document.getElementById(x.trim())
        reservedSeat.classList.remove('occupied')
        reservedSeat.classList.add('reserved')
    }
    }

    //Refresh the page
    function uiUpdateFunction(){
        document.location.reload();
    }
    //Initiate sending ticket data to view
    const buyButton = document.getElementById('buy-button')
    buyButton.addEventListener('click', e => {
        sendTicketData('{{seance.id}}', seatsNumbers.toString(), uiUpdateFunction);
    })

</script>

{% include 'movies/snippets/send_ticket_data.html' %}
{% endblock %}